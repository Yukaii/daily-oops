{"pageProps":{"content":"# 用 inlets 加上 caddy 實現窮人版的 https ngrok\n\n###### tags: `draft`\n\n> 我就客家\n\n\n## 準備一臺跑 Inlets 的伺服器\n\n看是用 GCP 還是 Linode，也可以用 inlets control 自動開機器。我這裡是用 gcp 的 always free tier\n\n\n##### `/etc/systemd/system/inlets.service`\n\n```ini\n[Unit]\nDescription=Inlets Server Service\nAfter=network.target\n\n[Service]\nType=simple\nRestart=always\nRestartSec=1\nStartLimitInterval=0\nEnvironmentFile=/etc/default/inlets\nExecStart=/usr/local/bin/inlets server --port=8000 --token=\"${AUTHTOKEN}\"\n\n[Install]\nWantedBy=multi-user.target\n```\n\n`echo 'export AUTHTOKEN=$(head -c 16 /dev/urandom | shasum | cut -d\" \" -f1)' > /etc/default/inlets`\n\n用下載 Caddy 的 deb 用 dpkg 安裝\n\n檢查一下有沒有 caddy service，若沒有照這個安裝：\n\nhttps://caddyserver.com/docs/install\n\n```bash\nsudo systemctl daemon-reload\nsudo systemctl enable inlets\nsudo systemctl start inlets\n```\n\n\n##### `/etc/caddy/Caddyfile`\n\n> Caddy v2 configuration\n\n```caddy\nbox.yukai.dev\nreverse_proxy localhost:8000\nreverse_proxy /tunnel localhost:8000\n```\n\n```\njournalctl -u inlets --follow\njournalctl -u caddy --follow\n```\n\n```bash\nsudo vim /etc/sudoers\n\n# caddy ALL=(ALL:ALL) NOPASSWD:ALL\n```\n\n```bash!\ninlets client --remote=wss://box.yukai.dev --upstream=http://localhost:3000 -t $TOKEN\n```\n\n\n### 補充：設定 Shell Function 讓使用起來方便\n\n```fish\nfunction tunnel --description \"ngrok alternative\"\n  set --local options 'p/port=!_validate_int' 'h/help'\n\n  argparse $options -- $argv\n\n  if set --query _flag_help; or not set -q _flag_port\n    printf \"Usage: tunnel [OPTIONS]\\n\\n\"\n    printf \"Options:\\n\"\n    printf \"  -p --port       Local port to bind\\n\"\n    return 0\n  end\n\n  eval \"inlets client --remote=wss://box.yukai.dev --upstream=http://localhost:$_flag_port -t $INLETS_AUTH_TOKEN\"\nend\n```\n\nconfig.fish\n\n```diff\n+ source $__fish_config_dir/secrets.fish\n```\n\n```fish\nset -x INLETS_AUTH_TOKEN asdfasdfasdfasdfasf\n```\n\n### 附錄\n\n再使用 GCP instance f1.micro always free，整套下來只需要買 domain (或也不需要)，更客家 :+1:\n\n\n### Reference\n\n- https://ksana410.github.io/2019/08/27/expose-your-local-endpoint-to-internet-with-inlets/\n- https://blog.alexellis.io/https-inlets-local-endpoints/\n- Alternatives: https://news.ycombinator.com/item?id=20410552\n- https://github.com/inlets/inletsctl 留言 provision 都要自動化，提一下 Pro 的自動 TLS\n- https://ianwu.tw/press/programming/tool/inlets.html#%E5%AE%89%E8%A3%9D%E6%96%B9%E5%BC%8F\n\n","title":"用 inlets 加上 caddy 實現窮人版的 https ngrok"},"__N_SSG":true}