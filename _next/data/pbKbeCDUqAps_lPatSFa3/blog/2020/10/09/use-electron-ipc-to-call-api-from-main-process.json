{"pageProps":{"content":"\n# åœ¨ Electron ä½¿ç”¨ IPC ä¸²è¯å‰ç«¯å’Œ Node API\n\né€™æ˜¯æˆ‘æœ€è¿‘åœ¨å¯¦ä½œå™—æµª electron app - [**Puraku**][puraku] æ™‚ï¼Œä½¿ç”¨çš„æŠ½è±¡åŒ–å¯«æ³•ã€‚\n\nå…ˆè«‡ä¸€ä¸‹èƒŒæ™¯ã€‚å…¶å¯¦åœ¨å®˜æ–¹çš„ [Plurk API][plurk-api] é é¢ä¸Šå°±å·²ç¶“æœ‰ [JavaScript çš„å™—æµª API Library][purakujs]äº†ï¼Œä¸éå®ƒæ²’æœ‰åŒ…æˆ npm å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œè€Œä¸”é‚„ç›¸ä¾æ–¼ [node-oauth][node-oauth] å¥—ä»¶ï¼Œçœ‹åå­—å°±çŸ¥é“å’Œ Node æœ‰é—œã€‚\n\né€™æ¬¡å¯«çš„ [puraku][puraku] æ˜¯ä¸€å€‹ä»¥å‰ç«¯ç‚ºä¸»çš„æ¡Œé¢è»Ÿé«”ï¼Œæ‰€ä»¥æˆ‘å‹¢å¿…è¦å°å™—æµªçš„ API å¥—ä»¶åšäº›æ”¹å¯«ã€‚\n\n**æ›´æ–°**ï¼š å…¶å¯¦ Electron renderer process å°±èƒ½å‘¼å« node API äº†ï¼Œåªæ˜¯æˆ‘å…ˆå…¥ç‚ºä¸»çš„ä»¥ç‚º main process æ‰èƒ½ä½¿ç”¨ï¼Œæ‰€ä»¥å¼•ç™¼äº†é€™å€‹è»Ÿé«”å•é¡Œ XDrzã€‚\n\n## é‡æ–°å°è£ API Library\n\næˆ‘å·²ç¶“åŒ…è£æˆ [purakujs][purakujs]ï¼Œå®ƒæ˜¯å€‹å¯ä»¥ç›´æ¥ä½¿ç”¨çš„ Plurk API Node libraryï¼Œé›–ç„¶é€™å¹´é ­ä¹Ÿæ²’å¤šå°‘å·¥ç¨‹å¸«åœ¨ä¸²å™—æµª API äº† ğŸ˜… ã€‚å€¼å¾—ä¸€æçš„æ˜¯ yarn å° `npm link` çš„æ”¯æ´ä¸å¤ªå¥½ï¼Œåœ¨è¨­å®šæœ¬æ©Ÿé–‹ç™¼ç’°å¢ƒè·‘å®Œ `npm link` å¾Œï¼Œä¸è¦åœ¨ `package.json` ä¿®æ”¹å¥—ä»¶ç‰ˆæœ¬ï¼Œé˜²æ­¢åœ¨è·‘ `yarn install` æŒ‡ä»¤æ™‚åˆå™´éŒ¯ã€‚\n\n### Electron\n\né—œæ–¼ Electron æ˜¯å•¥ä¾¿ä¸å†è´…è¿°ã€‚~~è¦çŸ¥é“çš„æ˜¯åªæœ‰åœ¨ Electron çš„ Main Process è£¡æ‰å¯ä»¥å‘¼å« node çš„ api~~ï¼ˆéŒ¯äº†ï¼‰ï¼Œæ‰€ä»¥æŠŠ node-oauth å¥—ä»¶æ”¾åœ¨é€™è·‘æ˜¯æ²’å•é¡Œçš„ï¼Œä½† Renderer Process æ‰æ˜¯ä¸»è¦è§¸ç™¼ API çš„åœ°æ–¹ï¼ˆæ›é ã€æ²å‹•ã€æŒ‰éˆ•ç­‰ï¼‰ã€‚Electron æä¾›äº† IPC çš„ API ç•Œé¢å¯¦ä½œï¼Œå¯ä»¥é€™æ¨£å¯«ï¼š\n\n> commit [df4c8a2](https://github.com/puraku/client/pull/5/commits/df4c8a225a36485747f7022b1391b50ee9e9f19c)\n\n```javascript\n// Renderer Process\nimport { ipcRenderer } from 'electron';\n\nexport function request(method, endpoint, params=null) {\n  return ipcRenderer.sendSync('puraku:api', {method, endpoint, params});\n}\n\n// Main Process\nipcMain.on('puraku:api', (event, args) => {\n  const { method, endpoint, params } = args;\n  myApiClient.request(method, endpoint, params).then(({data}) => {\n    event.returnValue = JSON.parse(data);\n  }).catch(error => {\n    event.returnValue = { error };\n  });\n});\n```\n\nRenderer Process é€å‡º API è«‹æ±‚åˆ° Main Processï¼Œå·²ç¶“æ­£åœ¨ç›£è½çš„ Main Process åœ¨å‘¼å«å®Œ API è«‹æ±‚(`myAPIClient.request`)ä¹‹å¾Œï¼Œè¿”é‚„è³‡æ–™çµ¦ Renderer Processã€‚åœ¨é€™è£¡é€é ipcMain å»ºç«‹å«åš `puraku:api` çš„äº‹ä»¶ç›£è½ï¼Œç”± `ipcRenderer` é€å‡ºäº‹ä»¶è«‹æ±‚ã€‚`event.returnValue` æ˜¯ ipc çš„åŒæ­¥å¯«æ³•ã€‚ä¸€æ—¦ä½¿ç”¨åŒæ­¥ï¼Œæ•´å€‹ Renderer Process åœ¨é€å‡ºäº‹ä»¶è«‹æ±‚(`ipcRenderer.sendSync`)ä¹‹å¾Œæœƒè¢« Blockï¼Œæ‰€ä»¥æˆ‘æ”¹ç”¨éåŒæ­¥çš„ IPC å¯«æ³•ï¼Œå†ç”¨ Promise å°è£ã€‚\n\n### Asyncronous IPC\n\n> commit [3f2fee](https://github.com/puraku/client/pull/5/commits/3f2fee64664c4082520a3a8b9ffe6d90cb6cfdbd)\n\n```javascript\n// Renderer Process\nimport { ipcRenderer } from 'electron';\n\nexport function request(method, endpoint, params=null) {\n  return new Promise((resolve, reject) => {\n    const timestamp = Date.now();\n    const result = ipcRenderer.send('puraku:api', {method, endpoint, params, timestamp});\n\n    ipcRenderer.once(`puraku:api:${endpoint}:${timestamp}`, (event, result) => {\n      if (result.hasOwnProperty('error')) {\n        reject(result);\n      } else {\n        resolve(result);\n      }\n    });\n  });\n}\n\n// Main Process\nipcMain.on('puraku:api', (event, args) => {\n  const { method, endpoint, params, timestamp } = args;\n  myApiClient.request(method, endpoint, params).then(({data}) => {\n    event.sender.send(`puraku:api:${endpoint}:${timestamp}`, JSON.parse(data));\n  }).catch(error => {\n    event.sender.send(`puraku:api:${endpoint}:${timestamp}`, {error});\n  });\n});\n```\n\né€™ä¸€ç‰ˆè·Ÿä¸Šé¢çš„å·®åˆ¥åœ¨æ–¼ï¼ŒRenderer Process é€è«‹æ±‚çµ¦ Main Process ä¹‹å¾Œï¼Œé¦¬ä¸Šå»ºç«‹å¦ä¸€å€‹ IPC çš„ Listener ç­‰å¾… Main Process å›èª¿ï¼Œè€Œ Main Process åœ¨è™•è£¡å®Œ API è«‹æ±‚ä¹‹å¾Œ(`myAPIClient.request`) å†ç”¨ IPC éåŒæ­¥å¯«æ³•å›å‚³è³‡æ–™(`event.sender.send`)ã€‚åœ¨é€™å€‹ç‰ˆæœ¬ IPC é—œä¿‚è®Šå¾—æ¯”è¼ƒè¤‡é›œï¼Œç°¡å–®ç•«äº†ä¸€ä¸‹ï¼š\n\n```txt\nPromise start  +-----+\n                     |           Renerer Process                 Main Process\n                     |\n                     +-----> +--------------------+\n                             |                    |\n                             |  ipcRenderer.send  |\n                             |                    |         +---------------------+\n                             +------------------------------+                     |\n                             |                    |         |  API request        |\n                             |  ipcRenderer.once  |         |                     |\n                             |                    |         |  event.sender.send  |\n                             |  create listener   |         |                     |\n                             |                    |         |                     |\n                             +---------+----------+         +-----------+---------+\n                                       |                                |\n                                       |                                |\n                                       |                                |\n                             +---------+----------+                     |\n                             |                    <---------------------+\n                             |   Event received   |\n                             |                    |\n                     +-----+ +---------+----------+\n                     |                 |\n                     |                 |\n Promise end   <-----+                 |\n                                       |\n                                       |\n                                       |\n                                       |\n                                       |\n                                       |\n                                       |\n                                       |\n                                       v\n```\n\n### IPC äº‹ä»¶ä¸€å°ä¸€å°æ‡‰\n\nå¯ä»¥ç™¼ç¾åœ¨é€™ä¸€ç‰ˆçš„ Renderer Process æˆ‘åŠ äº†ä¸€å€‹ `timestamp` ä¾†ç°¡å–®çš„å€åˆ†ä¸åŒçš„ API requestï¼Œå› ç‚ºå¦‚æœå…‰ç”¨ API çš„ Endpoint ç•¶åšäº‹ä»¶çš„éµå€¼ï¼Œæˆ³ç›¸åŒ API å…©æ¬¡æ™‚å°±æœƒè¡åˆ°ã€‚\n\n```javascript\nconst timestamp = Date.now();\nconst eventKey = `puraku:api:${endpoint}:${timestamp}`;\n```\n\nä¸éå»ç™¼ç¾æ¯æ¬¡å–çš„ timestamp é‚„æ˜¯æœ‰æ©Ÿæœƒä¸€æ¨£ï¼Œç¶“é Google ä¹‹å¾Œæˆ‘æŠŠ `timestamp` äº‚æ•¸çš„ç”¢ç”Ÿæ–¹æ³•æ”¹æˆ `performance.now()`ï¼š\n\n```javascript\nconst randomSeed = performance.now();\nconst eventKey = `puraku:api:${endpoint}:${randomSeed}`;\n```\n\nåˆ°é€™è£¡ï¼Œæˆ‘å€‘å°±å¯ä»¥ç”¨ç†Ÿæ‚‰çš„ Promise ä»‹é¢ï¼Œåœ¨ Renderer Process è¼•é¬†åœ°ä¸²æ¥ Main Process çš„ API å•¦ï¼ä»¥ä¸‹æ˜¯ç›®å‰çš„å¯¦ä½œï¼š\n\n```javascript\n// Renderer Process\nimport { ipcRenderer } from 'electron';\n\nexport function request(method, endpoint, params = null) {\n  return new Promise((resolve, reject) => {\n    const randomSeed = performance.now();\n    ipcRenderer.send('puraku:api', { method, endpoint, params, randomSeed });\n\n    ipcRenderer.once(`puraku:api:${endpoint}:${randomSeed}`, (event, result) => {\n      if (result.hasOwnProperty('error')) {\n        reject(result);\n      } else {\n        resolve(result);\n      }\n    });\n  });\n}\n\n// Main Process\nconst { ipcMain } = require('electron');\n\nipcMain.on('puraku:api', (event, args) => {\n  const { method, endpoint, params, randomSeed } = args;\n  myApiClient.request(method, endpoint, params).then(({data}) => {\n    event.sender.send(`puraku:api:${endpoint}:${randomSeed}`, JSON.parse(data));\n  }).catch(error => {\n    event.sender.send(`puraku:api:${endpoint}:${randomSeed}`, {error});\n  });\n});\n```\n\nåœ¨ Renderer Process è£¡ï¼ˆåœ¨æˆ‘çš„ä¾‹å­è£¡æ˜¯ Vue å‰ç«¯ Appï¼‰å°±å¯ä»¥ç”¨ç°¡å–®çš„ä»‹é¢ä¾†å‘¼å« API å•¦ï¼\n\n## å…¶å®ƒ\n\nè½èªªç”¨ message queue ä¾†å¯¦ä½œæ¯”è¼ƒå¥½ï¼Œä¸é It works for nowï¼Œå°±æš«æ™‚æ²’æœ‰æ›´æ–°å¯¦ä½œçš„å‹•åŠ›ï¼ˆæ‡¶ï¼‰\n\nå¯ä»¥åœ¨ [puraku/client PR#5](https://github.com/puraku/client/pull/5) é–±è®€å¯¦ä½œçš„éç¨‹ã€‚è‡ªå¾å° Redmine ä¸Šç™®ä¹‹å¾Œï¼Œé€£ GitHub Flow ä¹Ÿä¸€ä½µæ„›ä¸Šäº†ï¼Œåœ¨æœ¬ Repo ä¸€å€‹åŠŸèƒ½å°±é–‹ Branch åšæˆ Pull Requestï¼Œå°±ç®—ä¸€å€‹äººçš„ GitHub Flow ä¹Ÿèƒ½ç©çš„æ„‰æ‚… XD\n\n\n[plurk-api]: https://www.plurk.com/API\n[puraku]: https://github.com/puraku/client\n[purakujs]: https://github.com/puraku/purakujs\n[plurkjs]: https://github.com/clsung/plurkjs\n[node-oauth]: https://github.com/ciaranj/node-oauth\n","title":"åœ¨ Electron ä½¿ç”¨ IPC ä¸²è¯å‰ç«¯å’Œ Node API"},"__N_SSG":true}