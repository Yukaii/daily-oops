{"pageProps":{"content":"\n# Jekyll 的文章搜尋功能\n\n![Imgur](https://i.imgur.com/3y5O9tZ.gif)\n\n前幾天在 HackerNews 上看到了這篇文章：[A search widget for static web sites](https://news.ycombinator.com/item?id=14717182)，原理就是抓取 RSS 的 xml 檔案\b\b當做搜尋的資料庫。\n\n既然都用 Jekyll 了，那產生一個更容易使用的格式，比如 JSON，就不用手寫 regex 去 match XML 啦。\n\n我直接用了 [Jekyll search using lunr.js](https://learn.cloudcannon.com/jekyll/jekyll-search-using-lunr-js/) 這篇文章的做法，在 JavaScript 塞入文章內容：\n\n```javascript\nvar store = {\n  {% for post in include.posts %}\n    \"{{ post.url | slugify }}\": {\n      \"title\": \"{{ post.title | xml_escape }}\",\n      \"url\": \"{{ post.url | xml_escape }}\",\n      \"author\": \"{{ post.author | xml_escape }}\",\n      \"category\": \"{{ post.category | xml_escape }}\",\n      \"content\": {{ post.content | strip_html | strip_newlines | jsonify }},\n      \"url\": \"{{ post.url | xml_escape }}\",\n      \"date\": \"{{ post.date | date: \"%b %-d, %Y\" }}\"\n    }\n    {% unless forloop.last %},{% endunless %}\n  {% endfor %}\n}\n```\n\n產生出來的檔案長這樣：\n\n```javascript\nvar store = {\n  \"blog-2017-06-28-windows-unix-like-development-guide-nodejs-ruby\": {\n    \"title\": \"Windows Unix-Like 環境設定踩坑紀錄\",\n    \"url\": \"/blog/2017/06/28/windows-unix-like-development-guide-nodejs-ruby/\",\n    \"author\": \"\",\n    \"category\": \"\",\n    \"content\": \"...\",\n    \"url\": \"/blog/2017/06/28/windows-unix-like-development-guide-nodejs-ruby/\",\n    \"date\": \"Jun 28, 2017\"\n  },\n  \"blog-2017-05-04-deploy-redmine-with-puma-nginx-migration-from-mysql-to-postgresql\": {\n    \"title\": \"使用 puma 和 nginx 部屬 Redmine（加上從 MySQL 搬到 PostgreSQL）\",\n    \"url\": \"/blog/2017/05/04/deploy-redmine-with-puma-nginx-migration-from-mysql-to-postgresql/\",\n    \"author\": \"\",\n    \"category\": \"\",\n    \"content\": \"...\",\n    \"url\": \"/blog/2017/05/04/deploy-redmine-with-puma-nginx-migration-from-mysql-to-postgresql/\",\n    \"date\": \"May 4, 2017\"\n  },\n  // ...\n}\n```\n\n然後用 `lunr.js` 做搜尋：\n\n```javascript\nvar idx = lunr(function () {\n  this.field('id');\n  this.field('title', { boost: 10 });\n  this.field('author');\n  this.field('category');\n  this.field('content');\n  this.field('url');\n  this.field('date');\n\n  for (var key in store) { // Add the data to lunr\n    this.add({\n      'id': key,\n      'title': store[key].title,\n      'author': store[key].author,\n      'category': store[key].category,\n      'content': store[key].content,\n      'url': store[key].url,\n      'date': store[key].date,\n    });\n  }\n});\n\nvar results = idx.search(searchTerm); // Get lunr to perform a search\n```\n\n再把結果產生成列表就行了。花了比較多時間在處裡產生的 store 資料上，比如 `jekyll-mention` 插件會把 `@` 開頭的轉換成 GitHub User 連結，以及 `jemoji` 插件會把 `:smile:` 轉成 GitHub 的 emoji 圖片連結，但在：\n\n```txt\npost.content | strip_html | strip_newlines | jsonify\n```\n\n這個轉換 pipeline 裡面沒法被消除掉，於是轉出來的 JavaScript 就會出現 SyntaxError（多換行啦、double quote 沒有 escape 等）。\n\n另一個問題是因為用到 HTML5 History API，跟 Turbolink 尬在一起就會炸。現在有時還會「回到上一頁但頁面不切換」之類的問題。就暫時放置 Play 了 XD\n\n更多請參考 commit [`bb3a006`](https://github.com/Yukaii/Blog/commit/bb3a006f690f1ceed8793f9fa0b950f6c043bca9) 囉。\n\n（完）\n","title":"Jekyll 的文章搜尋功能","params":{"year":"2017","month":"07","day":"12","slug":"search-in-jekyll"},"disqus":{"shortname":"dailyoops","domain":"yukaii.tw"},"noteId":"-3_QAHoUSnq9zCsN3JKGBg"},"__N_SSG":true}