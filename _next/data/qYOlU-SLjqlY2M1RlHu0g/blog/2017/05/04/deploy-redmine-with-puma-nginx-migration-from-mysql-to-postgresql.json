{"pageProps":{"content":"\n# ä½¿ç”¨ puma å’Œ nginx éƒ¨å±¬ Redmineï¼ˆåŠ ä¸Šå¾ MySQL æ¬åˆ° PostgreSQLï¼‰\n\nå‰é™£å­çœ‹äº†å¹¾ç¯‡ Linode å®‰åˆ©æ–‡ï¼Œæ¯æœˆäº”é‚çš„æ©Ÿå™¨å¥½åƒå°± Linode CP å€¼æœ€é«˜æƒ¹ï¼Œç®¡ç†ç•Œé¢é›–ç„¶çœ‹èµ·ä¾†é™½æ˜¥ï¼Œä½¿ç”¨èµ·ä¾†å€’æŒºæœ‰æ•ˆç‡çš„ã€‚é€™å¹¾å¤©å°±æŠŠæ“ºåœ¨ Vultr ä¸Šçš„è‡ªç”¨æœå‹™ (Redmineï¼Œå¹¾å€‹ crontab è…³æœ¬) æ¬åˆ°äº† Linode ä¸Šã€‚\n\né™¤äº†å–®ç´”çš„æ¬å®¶å¤–ï¼Œéƒ¨å±¬çš„ Redmine ä¹Ÿåšäº†ä¸€äº›èª¿æ•´ï¼š\n\n- 3.2 åˆ° 3.3\n- è³‡æ–™åº«ç”± MySQL è½‰æ›åˆ° PostgreSQL\n- Application server ç”± passenger æ›æˆ puma\n- ç‰ˆæ§ç”±å®˜æ–¹ svn æ›æˆ git mirrorï¼Œæ–¹ä¾¿æ“ä½œ XD\n\nç¸½ä¹‹æœ¬ç¯‡é™¤äº†æ˜¯æˆ‘çš„æ¬å®¶ç­†è¨˜ï¼Œé‚„å¯ä»¥è¦–ç‚º**è‡ªæ¶ Redmine æŒ‡å—**ï¼ˆå¤§æ¦‚å•¦ï¼‰ã€‚\n\n## è¨­å®šæ–°ä¼ºæœå™¨\n\nç›´æ¥åœ¨ Linode æ±äº¬é–‹äº†å° Ubuntu çš„ Instanceï¼Œç„¶å¾Œ ssh æ‰“å¯†ç¢¼é€£é€²å»ã€‚\n\n### è§£æ±º apt-get update å¡ä½å•é¡Œ\n\nè«‹åƒè€ƒ [apt-get update stuck: Connecting to security.ubuntu.com](https://askubuntu.com/a/787491)\n\n### è£ Dependency\n\né¦–å…ˆç•¶ç„¶å°±æŠŠç³»çµ±çš„ç›¸ä¾å¥—ä»¶è£ä¸€è£ï¼ŒåŒ…å« tmuxã€postgres è³‡æ–™åº«ç­‰ç­‰ã€‚æ»¿å»ºè­°å­¸ç¿’ä¸€ä¸‹ tmux çš„ã€‚å¯ä»¥é–‹å…©å€‹ tabï¼Œä¸€å€‹ root æ¬Šé™ï¼Œä¸€å€‹ä¸€èˆ¬æ¬Šé™ï¼Œæ–¹ä¾¿è¨±å¤šï¼Œä¸ç”¨ä¸€ç›´åˆ‡ suã€‚\n\n```bash\napt-get update && apt-get upgrade && apt-get install -y git build-essential tmux postgresql libpq-dev # database\napt-get install -y libssl-dev libreadline-dev zlib1g-dev # ruby dependency\napt-get install -y imagemagick libmagickcore-dev libmagickwand-dev # redmine dependency\n```\n\n### å»ºç«‹ deploy ç”¨çš„ä½¿ç”¨è€…\n\næˆ‘ä¸å¸Œæœ›ç›´æ¥ç”¨ root å¸³è™Ÿè·‘èµ· Redmine æœå‹™ã€‚ç¸½ä¹‹å°±æ˜¯å®‰å…¨æ€§ç–‘æ…®å•¦ XDã€‚ç›´æ¥æ‰“ `adduser` èµ°å®Œéç¨‹ï¼š\n\n```bash\nadduser deploy\n```\n\n### å®‰è£ Redmine\n\n#### ä¸‹è¼‰åŸå§‹ç¢¼\n\nåˆ‡åˆ° `deploy` å¸³è™Ÿï¼ŒæŠŠ redmine clone ä¸‹ä¾†ï¼Œä¸¦æŠŠè¨­å®šæª”å¼„å¥½ï¼š\n\n```bash\nsu deploy\ncd ~ # åˆ‡åˆ°å®¶ç›®éŒ„\ngit clone https://github.com/redmine/redmine\n\ncd redmine\ngit checkout -b 3.3-stable origin/3.3-stable\n\ncp config/database.yml.example config/database.yml\ncp config/configuration.yml.example config/configuration.yml\n```\n\n#### å»ºç«‹ Ruby ç’°å¢ƒ\n\nä½¿ç”¨ [rbenv](https://github.com/rbenv/rbenv) è£ rubyï¼Œç›´æ¥ç…§è‘—æ­¥é©Ÿè·‘ï¼š\n\n```bash\ngit clone https://github.com/rbenv/rbenv.git ~/.rbenv\ncd ~/.rbenv && src/configure && make -C src\necho 'export PATH=\"$HOME/.rbenv/bin:$PATH\"' >> ~/.bash_profile # linode ä¸Šæ˜¯ .bashrc\n~/.rbenv/bin/rbenv init # è²¼ä¸Šè¼¸å‡ºåˆ° .bash_profile æˆ– .bashrc\ngit clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build # è£ ruby build\n```\n\nè£ rubyï¼š\n\n```bash\nrbenv install 2.3.4\nrbenv global 2.3.4\necho 'gem: --no-ri --no-rdoc' >> ~/.gemrc\ngem install bundler\n```\n\n#### è¨­å®šè³‡æ–™åº«\n\nç”¨å¥½æ£’æ£’çš„ [`pgcli`](https://github.com/dbcli/pgcli) èˆ‡æœ¬æ©Ÿ postgres å»ºç«‹é€£ç·šã€‚ä¸Šé¢ APT å¥—ä»¶è£å®Œå¾Œæ‡‰è©²å°±æœƒè‡ªå·±è·‘èµ·ä¾†äº†ã€‚\n\n```bash\napt-get install pgcli\nsudo -i -u postgres\npgcli\n```\n\né€²å»ä»¥å¾Œï¼Œå»ºç«‹ä½¿ç”¨è€…å’Œè³‡æ–™åº«ï¼š\n\n```sql\nCREATE USER redmine WITH PASSWORD 'PASSWORD';\nCREATE DATABASE redmine;\nGRANT ALL PRIVILEGES ON DATABASE redmine to redmine;\n```\n\n##### æ¸¬è©¦é€£ç·š(Optional)\n\nä»¥é˜²å¯†ç¢¼æ‰“éŒ¯é€™ç¨®å¥‡å¦™äº‹ä»¶ç™¼ç”Ÿï¼Œæˆ‘å€‘å¯ä»¥æ¸¬è©¦ä¸€ä¸‹é€£ç·šã€‚æ‰“é–‹ `/etc/postgresql/9.5/main/pg_hba.conf`ï¼Œæ‰¾åˆ°ä¸‹é¢åŠ å…¥é€™è¡Œï¼š\n\n```txt\nlocal   all             redmine                                 md5\n```\n\né€™è¡Œé–‹å•Ÿæœ¬åœ°ç«¯çš„å¸³å¯†æˆæ¬Šç™»å…¥ã€‚ç„¶å¾Œç”¨ `psql` é€£ç·šæœ¬æ©Ÿæ¸¬è©¦ï¼š\n\n```bash\npsql -U redmine -d redmine -W\n```\n\næˆåŠŸé€£é€²å»å°± Ok å•¦ã€‚\n\n#### è¨­å®š Redmine è³‡æ–™åº«\n\n1. ç·¨è¼¯ `config/database.yml` å¡«å…¥è³‡æ–™åº«å¸³å¯†ï¼ŒæŠŠ `mysql` ç›¸é—œçš„éƒ½è¨»è§£æ‰(development ç­‰ç­‰)\n1. ç„¶å¾Œå®‰è£ redmine çš„ gem dependency\n\n```bash\nbundle install --without development test\n```\n\n##### Migrate from old redmine (Optinoal)\n\nè¤‡è£½ä»¥ä¸‹æª”æ¡ˆï¼š\n\n- `config/initializers/secret_token.rb`\n- `config/database.yml`\n- `config/configuration.yml`\n\nå¾ MySQL æ¬å®¶åˆ° Postgres çš„éƒ¨åˆ†ï¼Œå› ç‚ºéƒ½æ˜¯åŒä¸€å€‹ Appï¼ŒRedmine ç‰ˆæœ¬ä¹Ÿåªæ˜¯å°å‡æ²’æœ‰å¤§å‹ migrationï¼Œæˆ‘ç›´æ¥åˆ©ç”¨[`yaml_db`](https://github.com/yamldb/yaml_db) å¥—ä»¶ï¼ŒæŠŠè³‡æ–™åº« dump å‡ºä¾†æˆ yamlï¼Œç„¶å¾Œåœ¨ load å°±è¡Œäº† ğŸ˜ å¯ä»¥åƒè€ƒ [`yaml_db`](https://github.com/yamldb/yaml_db) å¥—ä»¶ GitHub èªªæ˜ã€‚\n\nå…ˆè·‘ `RAILS_ENV=production bundle exec rake db:setup` å»ºç«‹è³‡æ–™åº«ï¼Œç„¶å¾Œåœ¨ `bundle exec rake db:data:load` æŠŠæª”æ¡ˆè¼‰å…¥é€²ä¾†ã€‚\n\n## è¨­å®š Puma\n\nåœ¨ Gemfile åŠ ä¸Š `gem 'puma'` ä¸€è¡Œï¼Œç„¶å¾Œè·‘ `bundle install --without development test` å®‰è£ã€‚å†ä¾†ç·¨è¼¯ `config/puma.rb` è²¼ä¸Šä»¥ä¸‹å…§å®¹ï¼š\n\n```ruby\n#!/usr/bin/env puma\n\napplication_path = '/home/deploy/redmine'\ndirectory application_path\nenvironment 'production'\n# daemonize true\npidfile \"#{application_path}/tmp/pids/redmine.pid\"\nstate_path \"#{application_path}/tmp/pids/redmine.state\"\nstdout_redirect \"#{application_path}/log/redmine.stdout.log\", \"#{application_path}/log/redmine.stderr.log\"\nbind \"unix://#{application_path}/tmp/sockets/redmine.sock\"\n```\n\nè¨˜å¾—å»ºç«‹ `pids` å’Œ `sockets` è³‡æ–™å¤¾ï¼š\n\n```bash\ncd ~/redmine\nmkdir tmp/sockets tmp/pids\n```\n\nå¯ä»¥ç”¨ä»¥ä¸‹æŒ‡ä»¤è©¦è·‘ Serverï¼š\n\n```bash\nRAILS_ENV=production bundle exec puma -C config/puma.rb\n```\n\n## è¨­å®š systemctl è‡ªå•Ÿå‹•\n\nç”¨ root æ¬Šé™ç·¨è¼¯ `/etc/systemd/system/redmine.service`ï¼š\n\n```Ini\n[Unit]\nDescription=Rails-Puma Webserver\n\n[Service]\nType=simple\nUser=deploy\nWorkingDirectory=/home/deploy/redmine\nExecStart=/bin/bash -lc 'bundle exec puma -C config/puma.rb'\nTimeoutSec=15\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\n```\n\nè·‘èµ·ä¾†ï¼š\n\n```bash\nsystemctl daemon-reload # é‡æ–°è¼‰å…¥è¨­å®šæª”\nsystemctl enable redmine.service # è¨­ç‚ºé–‹æ©Ÿå•Ÿå‹•\nsystemctl start redmine.service # å•Ÿå‹•\nsystemctl status redmine.service # çœ‹ç‹€æ…‹\n```\n\n## æŠŠ nginx è·Ÿ puma socket server æ¥èµ·ä¾†\n\nç·¨è¼¯ `/etc/nginx/sites-available/redmine`ï¼š\n\n```nginx\nupstream app {\n        server unix:/home/deploy/redmine/tmp/sockets/redmine.sock fail_timeout=0;\n}\n\nserver {\n        listen 80 default_server;\n        listen [::]:80 default_server;\n\n        server_name localhost;\n        root /home/deploy/redmine/public;\n        try_files $uri/index.html $uri @app;\n\n        location @app {\n                proxy_pass http://app;\n                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n                proxy_set_header Host $http_host;\n                proxy_redirect off;\n        }\n\n        error_page 500 502 503 504 /500.html;\n        client_max_body_size 4G;\n        keepalive_timeout 10;\n}\n```\n\nè¨˜å¾— soft link å› `/etc/nginx/sites-enabled/`åº•ä¸‹ï¼š\n\n```bash\ncd /etc/nginx/sites-enabled\nln -s ../sites-available/redmine .\n```\n\né‡å•Ÿ `nginx`ï¼š\n\n```bash\nservice nginx restart\nservice nginx status\n```\n\næ‰“é–‹ç€è¦½å™¨é€£ IP æ‡‰è©²å°±èƒ½çœ‹åˆ°è¾£ï¼\n\n## ç›®å‰çš„ Plugin åˆ—è¡¨\n\n- [redmine_emojibutton](www.redmine.org/plugins/redmine_emojibutton): Emoji è¬æ­²ï¼\n- [redmine\\_markdown\\_task\\_list](https://github.com/eichisanden/redmine_markdown_task_list): Checklist\n- [redmine_mentions](http://www.redmine.org/plugins/redmine-mentions): Tag äººå¯„ email\n\n## References\n\n* https://gist.github.com/velenux/6883dc221a7d2eae7dcb\n* https://gist.github.com/jbradach/6ee5842e5e2543d59adb for config/puma.rb\n* https://www.digitalocean.com/community/tutorials/how-to-deploy-a-rails-app-with-puma-and-nginx-on-ubuntu-14-04\n* https://github.com/puma/puma/blob/master/docs/systemd.md\n* https://github.com/puma/puma/blob/master/docs/nginx.md\n* https://github.com/yamldb/yaml_db\n","title":"ä½¿ç”¨ puma å’Œ nginx éƒ¨å±¬ Redmineï¼ˆåŠ ä¸Šå¾ MySQL æ¬åˆ° PostgreSQLï¼‰"},"__N_SSG":true}